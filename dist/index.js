!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("AutoProgress",e):t.AutoProgress=e()}(this,function(){"use strict";function t(t){return Array.prototype.slice.call(t)}function n(t,e,n){var r,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!t[e])throw"Old function does not exist!";null===s&&(s=t);var o={callback:function(t){r=t}},i=t[e];return t[e]=function(){for(var e=arguments.length,o=Array(e),a=0;a<e;a++)o[a]=arguments[a];n.apply(s,o);var h=i.apply(t,o);if(r){var c=r.call(s,h);c&&null!==c&&(h=c)}return h},o}function r(){this.eventTarget=document.createDocumentFragment()}function s(){r.call(this),this.total=0,this.done=0,this.weight=1,this.waiting=!1,this.options={waitAfterStart:100},this.progressEvent=new Event("progress"),this.activeTimer=null}function o(){s.call(this);var t=this,e=window.XMLHttpRequest;window.XMLHttpRequest=function(){var r=new e;return n(r,"send",function(){return t.total++}),r.addEventListener("load",function(e){return t.handleElement()}),r.addEventListener("error",function(e){return t.handleElement()}),r}}function i(){s.call(this),n(window,"fetch",function(){this.total++},this).callback(function(t){var e=this;return t.then(function(t){return e.handleElement(),t})})}function a(){var n=this;s.call(this),this.trackedElements=[],this.elements=[function(){var e=t(document.querySelectorAll("img"));for(var r in e){var s=e[r];if(s.complete||n.trackedElements.includes(s))return;n.total++,s.addEventListener("load",function(){return n.handleElement()}),s.addEventListener("error",function(){return n.handleElement()}),n.trackedElements.push(s)}},function(){var r=t(document.querySelectorAll("audio")).concat(t(document.querySelectorAll("video")));for(var s in r){var o=r[s];if(o.readyState<2||n.trackedElements.includes(e))return;n.total++,"auto"==o.preload||o.autoplay?(o.addEventListener("canplay",function(){return n.handleElement()}),o.addEventListener("error",function(){return n.handleElement()})):n.handleElement(),n.trackedElements.push(e)}}],document.onreadystatechange=function(t){"interactive"==document.readyState?(n.search(),n.total++):"complete"==document.readyState&&n.handleElement()}}function h(){r.call(this),this.options={},this.defaultOptions={restartOnPopstate:!0,fallbackHashChange:!0,restartCooldown:1e3},this.totalProgress=0,this.trackers=[],this.canRestart=!0,this.restartCooldown=1e3,this.events={progress:new Event("progress"),finished:new Event("finished")},this.addTracker(o),window.fetch&&"function"==typeof window.fetch&&this.addTracker(i),this.addTracker(a),this.setOptions(this.defaultOptions)}return Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(t,e){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),r=n.length>>>0;if(0===r)return!1;var s,o,i=0|e,a=Math.max(i>=0?i:r-Math.abs(i),0);for(;a<r;){if((s=n[a])===(o=t)||"number"==typeof s&&"number"==typeof o&&isNaN(s)&&isNaN(o))return!0;a++}return!1}}),r.prototype.addEventListener=function(t,e,n,r){return this.eventTarget.addEventListener(t,e,n,r)},r.prototype.dispatchEvent=function(t){var e="on"+t.type;return this[e]&&this[e](t),this.eventTarget.dispatchEvent(t)},r.prototype.removeEventListener=function(t,e,n){return this.eventTarget.removeEventListener(t,e,n)},(s.prototype=Object.create(r.prototype)).handleElement=function(){0!=this.total&&this.done!=this.total&&(this.done++,this.dispatchEvent(this.progressEvent))},s.prototype.getProgress=function(){return 0===this.total?this.waiting?0:100:this.done/this.total*100},s.prototype.start=function(){var t=this;arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&(this.total=0,this.done=0),null!==this.activeTimer&&clearTimeout(this.activeTimer),this.waiting=!0,this.activeTimer=setTimeout(function(){t.waiting=!1,t.search&&t.search(),0==t.total&&t.dispatchEvent(t.progressEvent),t.activeTimer=null},this.options.waitAfterStart)},o.prototype=Object.create(s.prototype),i.prototype=Object.create(s.prototype),(a.prototype=Object.create(s.prototype)).search=function(){for(var t in this.elements)this.elements[t]()},(h.prototype=Object.create(s.prototype)).updateProgress=function(){var t,e,n;100!=this.totalProgress&&(this.totalProgress=(t=this.trackers,e=0,n=0,t.forEach(function(t){var r=t.weight||1;n+=r*t.getProgress(),e+=r}),n/e),this.dispatchEvent(this.events.progress),100==this.totalProgress&&this.dispatchEvent(this.events.finished))},h.prototype.addTracker=function(t){var e=this,n=new t;n.start(!1),this.trackers.push(n),this.updateProgress(),n.addEventListener("progress",function(){return e.updateProgress()})},h.prototype.restart=function(){var t=this;if(this.canRestart){for(var e in this.totalProgress=0,this.trackers)this.trackers[e].start(!0);this.updateProgress(),0!=this.restartCooldown&&(this.canRestart=!1,setTimeout(function(){t.canRestart=!0},this.restartCooldown))}},h.prototype.getProgress=function(){return this.totalProgress},h.prototype.setLoadTimeout=function(t){var e=this;setTimeout(function(){100!=e.totalProgress&&(e.totalProgress=100,e.dispatchEvent(e.events.progress),e.dispatchEvent(e.events.finished))},t)},h.prototype.setOption=function(t,e){var r=this;if("restartCooldown"==t&&!isNaN(e)&&e>0)this.restartCooldown=e;else if("restartOnPopstate"==t&&window.history&&e!==this.options[t])if(this.options[t]=e,e){var s=function(){r.options.restartOnPopstate&&r.restart()};n(window.history,"pushState",s,this),n(window.history,"replaceState",s,this),window.addEventListener("popstate",function(){return r.restart()})}else window.offEventListener("popstate",function(){return r.restart()});else if("restartOnHashChange"==t||!window.history&&"fallbackHashChange"==t){if(e===this.options[t])return;this.options[t]=e,e?window.addEventListener("hashchange",function(){return r.restart()}):window.offEventListener("hashchange",this.restart)}else for(var o in this.trackers)this.trackers[o].options&&this.trackers[o].options[t]&&(this.trackers[o].options[t]=e)},h.prototype.setOptions=function(t){for(var e in t)this.setOption(e,t[e])},new h});